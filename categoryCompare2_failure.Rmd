---
title: "Test CC2 Failure Reproducibly"
author: "Robert M Flight"
output:
  word_document: default
  pdf_document: default
editor_options: 
  chunk_output_type: console
---


```{r run_enrichments}
set.seed(1234)
create_go_annotation = function(db, ontology = NULL){
  all_genes = keys(db)
  go_all_gene = AnnotationDbi::select(db, keys = all_genes, columns = c("GOALL", "ONTOLOGYALL"))
  
  if (!is.null(ontology)) {
    go_all_gene = go_all_gene[go_all_gene$ONTOLOGYALL == ontology, ]
    ontology_type = paste0("GO.", ontology)
  } else {
    ontology_type = "GO.all"
  }
  go_2_gene = split(go_all_gene$ENTREZID, go_all_gene$GOALL)
  go_2_gene = lapply(go_2_gene, unique)
  go_desc = AnnotationDbi::select(GO.db::GO.db, keys = names(go_2_gene), columns = "TERM", keytype = "GOID")$TERM
  names(go_desc) = names(go_2_gene)

  go_annotation = categoryCompare2::annotation(annotation_features = go_2_gene,
                                               description = go_desc,
                                               annotation_type = ontology_type,
                                               feature_type = "ENTREZID")
  go_annotation
}


library(org.Hs.eg.db)
library(GO.db)
library(categoryCompare2)
library(methods)

go_mf = create_go_annotation(org.Hs.eg.db, "MF")

all_features = unique(unlist(go_mf@annotation_features))
sig_features = sample(all_features, 500)

enrich = hypergeometric_feature_enrichment(
  new("hypergeom_features", significant = sig_features,
      universe = all_features,
      annotation = go_mf),
  p_adjust = "BH"
)

comb_enrich = combine_enrichments(sig1 = enrich)
sig_cutoff = 0.1
filter_enrich = get_significant_annotations(comb_enrich, padjust <= sig_cutoff)
```